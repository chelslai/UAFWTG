<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Monthly UAF WTG Comd Calendar</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #1e1e2f;
      color: #fff;
      padding: 1rem;
      text-align: center;
    }
    .calendar-nav {
      margin-bottom: 1rem;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 1rem;
      flex-wrap: wrap;
    }
    .calendar-nav button {
      background: none;
      color: #fff;
      font-family: 'Segoe UI', sans-serif;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
    }
    #monthTitle {
      font-size: 1.5rem;
      font-weight: bold;
      border: 1px solid #fff;
      border-radius: 10px;
      padding: 0.5rem 1rem;
      background-color: #2d2d44;
    }
    .calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 0.3rem;
      margin-top: 1rem;
    }
    .day {
      background: #2d2d44;
      padding: 0.5rem;
      border-radius: 10px;
      min-height: 80px;
    }
    .day.weekend {
      background: #555;
      color: #ccc;
    }
    .day h4 {
      margin: 0 0 0.3rem;
      font-size: 0.8rem;
    }
    .assigned {
      font-weight: bold;
      background: #ffffff;
      color: #1e1e2f;
      border-radius: 8px;
      padding: 0.3rem;
      width: fit-content;
      margin: 0 auto;
      font-size: 0.8rem;
    }
    #swapForm {
      margin-top: 2rem;
      background: #2d2d44;
      padding: 1rem;
      border-radius: 10px;
      max-width: 100%;
    }
    #swapForm select, #swapForm input {
      margin: 0.5rem auto;
      padding: 0.5rem;
      border-radius: 5px;
      border: none;
      display: block;
      width: 100%;
      max-width: 300px;
    }
    #popup {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    #popupContent {
      background: #2d2d44;
      padding: 2rem;
      border-radius: 10px;
      z-index: 1001;
      width: 90%;
      max-width: 400px;
    }
    .button {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 5px;
      margin: 0.5rem;
      background: #4caf50;
      color: white;
      cursor: pointer;
    }
    @media (max-width: 600px) {
      .calendar {
        grid-template-columns: repeat(3, 1fr);
      }
      .calendar-nav {
        flex-direction: column;
      }
      #monthTitle {
        font-size: 1.2rem;
      }
    }
  </style>
</head>
<body>
<h1>ðŸ“… Monthly UAF WTG Comd Calendar</h1>
<div class="calendar-nav">
  <button id="prevBtn">â—€</button>
  <span id="monthTitle"></span>
  <button id="nextBtn">â–¶</button>
</div>
<div class="calendar" id="calendar"></div>
<div id="swapForm">
  <h2>REQUEST SWAP</h2>
  <label>
    <input type="checkbox" id="acknowledgeBox" />
    I am unavailable to the date assigned. I have informed the person I am swapping with to the changes made.
  </label><br><br>
  <label>You Are?:
    <select id="personSelect"></select>
  </label><br>
  <label>Swap From (dd/mm/yyyy):
    <input type="date" id="fromDate">
  </label><br>
  <label>Swap To (dd/mm/yyyy):
    <input type="date" id="toDate">
  </label><br>
  <button class="button" id="inputSwapBtn">Input Swap</button>
  <button class="button" id="downloadLogBtn" style="background:#2196F3">Download Swap Log</button>
</div>
<div id="popup">
  <div id="popupContent">
    <p>Are you sure?</p>
    <button class="button" id="yesBtn">Yes</button>
    <button class="button" id="noBtn" style="background:#f44336">No</button>
  </div>
</div>
<script>
const people = ["DC", "2IC", "DSM", "HD DCS"];
let assignments = {};
let currentMonth = new Date().getMonth();
let currentYear = new Date().getFullYear();
let swapRequest = {};
let swapHistory = [];

function getLocalDateString(date) {
  return new Date(date).toLocaleDateString('en-CA');
}

function preloadAssignments(year, month) {
  const date = new Date(year, month, 1);
  let personIndex = 0;
  assignments = {};
  while (date.getMonth() === month) {
    const day = date.getDay();
    const dateStr = getLocalDateString(date);
    if (day !== 0 && day !== 6) {
      assignments[dateStr] = people[personIndex % people.length];
      personIndex++;
    }
    date.setDate(date.getDate() + 1);
  }
}

function renderCalendar(month, year) {
  const calendar = document.getElementById("calendar");
  calendar.innerHTML = "";
  const monthTitle = document.getElementById("monthTitle");
  const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
  monthTitle.textContent = `Month: ${monthNames[month]} ${year}`;

  const firstDay = new Date(year, month, 1).getDay();
  const daysInMonth = new Date(year, month + 1, 0).getDate();

  for (let i = 0; i < firstDay; i++) {
    const emptyCell = document.createElement("div");
    calendar.appendChild(emptyCell);
  }

  for (let date = 1; date <= daysInMonth; date++) {
    const dayDiv = document.createElement("div");
    const thisDate = new Date(year, month, date);
    const dateStr = getLocalDateString(thisDate);
    dayDiv.classList.add("day");
    if (thisDate.getDay() === 0 || thisDate.getDay() === 6) {
      dayDiv.classList.add("weekend");
    }
    const dateLabel = document.createElement("h4");
    dateLabel.textContent = `${thisDate.toLocaleDateString('en-GB', { weekday: 'short', day: '2-digit', month: 'short' })}`;
    dayDiv.appendChild(dateLabel);
    if (assignments[dateStr]) {
      const assigned = document.createElement("div");
      assigned.classList.add("assigned");
      assigned.textContent = assignments[dateStr];
      dayDiv.appendChild(assigned);
    }
    calendar.appendChild(dayDiv);
  }
}

function changeMonth(offset) {
  currentMonth += offset;
  if (currentMonth < 0) {
    currentMonth = 11;
    currentYear--;
  } else if (currentMonth > 11) {
    currentMonth = 0;
    currentYear++;
  }
  preloadAssignments(currentYear, currentMonth);
  renderCalendar(currentMonth, currentYear);
  populatePersonSelect();
}

function populatePersonSelect() {
  const select = document.getElementById("personSelect");
  select.innerHTML = "";
  people.forEach(person => {
    const option = document.createElement("option");
    option.value = person;
    option.textContent = person;
    select.appendChild(option);
  });
}

function confirmSwap() {
  const fromDate = document.getElementById('fromDate').value;
  const toDate = document.getElementById('toDate').value;
  const acknowledged = document.getElementById('acknowledgeBox').checked;
  const person = document.getElementById('personSelect').value;

  const fromStr = getLocalDateString(fromDate);
  const toStr = getLocalDateString(toDate);

  if (!acknowledged) {
    alert('Please confirm you have informed the person you are swapping with.');
    return;
  }
  if (!fromStr || !toStr) {
    alert('Please select both dates.');
    return;
  }
  if (assignments[fromStr] !== person) {
    alert('You are not assigned to the from-date.');
    return;
  }
  swapRequest = { from: fromStr, to: toStr, person };
  document.getElementById('popup').style.display = 'flex';
}

function applySwap() {
  const { from, to, person } = swapRequest;
  const swappedWith = assignments[to];

  swapHistory.push(`"${new Date().toLocaleString()}","${person}","${from}","${to}","${swappedWith}"`);

  const temp = assignments[to];
  assignments[to] = assignments[from];
  assignments[from] = temp;

  renderCalendar(currentMonth, currentYear);
  document.getElementById('popup').style.display = 'none';
}

function closePopup() {
  document.getElementById('popup').style.display = 'none';
}

function downloadLog() {
  let csv = "timestamp,person,from_date,to_date,swapped_with\n" + swapHistory.join("\n");
  const blob = new Blob([csv], { type: "text/csv" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "swap_log.csv";
  a.click();
  URL.revokeObjectURL(url);
}

document.getElementById("prevBtn").addEventListener("click", () => changeMonth(-1));
document.getElementById("nextBtn").addEventListener("click", () => changeMonth(1));
document.getElementById("inputSwapBtn").addEventListener("click", confirmSwap);
document.getElementById("yesBtn").addEventListener("click", applySwap);
document.getElementById("noBtn").addEventListener("click", closePopup);
document.getElementById("downloadLogBtn").addEventListener("click", downloadLog);

preloadAssignments(currentYear, currentMonth);
renderCalendar(currentMonth, currentYear);
populatePersonSelect();
</script>
<script src="script.js"></script>
</body>
</html>
